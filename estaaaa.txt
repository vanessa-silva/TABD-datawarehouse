SELECT 
	taxi_id,
	T.tempo_id, 
	(SELECT id FROM taxi_stands WHERE st_distance(initial_point, location)  = (SELECT MIN(st_distance(initial_point, location)) FROM taxi_stands)), 
	(SELECT id FROM taxi_stands WHERE st_distance(final_point, location)  = (SELECT MIN(st_distance(final_point, location)) FROM taxi_stands)), 
	SUM(final_ts - initial_ts) * INTERVAL '1 second' 

FROM taxi_services 

INNER JOIN dw_tempo as T ON 
	cast((TIME '00:00' + initial_ts * INTERVAL '1 second') as text) = T.hora_i 
	AND 
	cast(date_part('day', (TIMESTAMP 'epoch' + initial_ts * INTERVAL '1 second')) as text) = T.dia_i 
	AND 
	cast(date_part('month', (TIMESTAMP 'epoch' + initial_ts * INTERVAL '1 second')) as text) = T.mes_i 
	AND
	cast((TIME '00:00' + final_ts * INTERVAL '1 second') as text) = T.hora_f 
	AND 
	cast(date_part('day', (TIMESTAMP 'epoch' + final_ts * INTERVAL '1 second')) as text) = T.dia_f 
	AND 
	cast(date_part('month', (TIMESTAMP 'epoch' + final_ts * INTERVAL '1 second')) as text) = T.mes_f 

WHERE
	final_ts > initial_ts 

GROUP BY 1,2,3,4

ORDER BY 1 DESC